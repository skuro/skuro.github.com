<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html>
  <head>
    <title>SKURO! -- Shading lights</title>
    <meta name="generator" content="skuro.tk/0.1 | enlive/1.0.0" />
    <meta name="description" content="Personal Blog of Carlo Sciolla" />
    <meta name="keywords" content="clojure,enlive,moustache,java,alfresco,lambdalf,performance" />
    <link rel="stylesheet" href="/css/skuro.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="/css/font.css" type="text/css" media="screen" />
  </head>
  <body>
    <div id="container">
    <div id="wrapper">
      <div id="sidebar">
        <h1 class="homelink" id="logo">SKURO!</h1>
        <div id="links">
          <span>
            <a href="/archive/">archive</a>
          </span>
          <span>
            <a href="/category/">categories</a>
          </span>
          <span>
            <a href="/about/">about</a>
          </span>
        </div>
        <img class="homelink" src="/img/avatar.jpg" id="avatar" />
        <h4 id="underlogo">shading lights</h4>
        <div id="social">
          <div id="mousing"></div>
          <a href="http://github.com/skuro">
            <img src="/img/github.png" id="github" />
          </a>
          <a href="http://twitter.com/skuro">
            <img src="/img/twitter.png" id="twitter" />
          </a>
          <a href="http://feeds.feedburner.com/Skuro">
            <img src="/img/rss.png" id="rss" />
          </a>
          <a href="http://nl.linkedin.com/in/carlosciolla">
            <img src="/img/linkedin.png" id="linkedin" />
          </a>
        </div>
        <div id="googleads">
          <script type="text/javascript">
            <!--
                google_ad_client = "ca-pub-5536661153340295";
                /* jekyll-site */
                google_ad_slot = "1546169966";
                google_ad_width = 120;
                google_ad_height = 240;
                //-->
          </script>
          <script type="text/javascript"
                  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
          </script>
        </div>
      </div>
      
      <div id="content">
        <div class="post">
  <h1 class="title">
  <a href="/2011/01/24/performance-boost-in-clojure-1-3">Performance boost in Clojure 1.3 (alpha4)</a>
</h1>
<h2 class="date">
  January 24, 2011
  
   -- filed under 
  
  <a href="/category/clojure">#clojure</a>
  
  
</h2>

  
  <p>As release 1.3 of Clojure is <a href="http://www.assembla.com/spaces/clojure/milestones/238781-release-next">on its way</a>, I decided to give the currently available alpha4 a try and see some of the good stuff it brings. First thing first, I wanted to experiment myself with the performance gain that the extended support for native types would bring. I ran into an old <a title="old post, but inspirational" href="http://hughw.blogspot.com/2009/01/clojure-vs-javafx-script-only-5x-slower.html">post</a> from which I got the inspiration for the specific test to run: the <a title="Takeuchi function on Wikipedia" href="http://en.wikipedia.org/wiki/Tak_(function)">Takeuchi function</a>.</p>

<p><img class="aligncenter size-full wp-image-340" title="Full disclosure: I own a Triumph Street Triple and I love Clojure" src="/img/post/clj-triple.jpg" alt="Full disclosure: I own a Triumph Street Triple and I love Clojure" width="375" height="322" /></p>

<p>The Java implementation for Tak provided me with a bottom line for performance comparison:</p>

<script src="https://gist.github.com/788834.js?file=Tak.java"></script>


<p> Then I used the Clojure version provided in the original blog post run to test against Clojure 1.2: <script src="https://gist.github.com/788834.js?file=tak2.clj"></script></p>

<p>Finally, I leveraged the new syntax for the <a href="http://dev.clojure.org/display/doc/Enhanced+Primitive+Support">enhanced primitives support</a> to test against Clojure 1.3 (thanks to <a href="http://twitter.com/neotyk">neotyk</a> to point that out to me):</p>

<script src="https://gist.github.com/788834.js?file=tak.clj"></script>


<p>As you can see, timing is tracked from the application code, as various accessory overhead like JVM and Clojure runtime bootstrap are not in the scope of this post.</p>

<p>As this benchmark is "just for fun", I won't pretent I did an extensive benchmark, or that I engineered a bullet proof benchmark strategy and the like. I just ran the above code some tens of times and here follows the average running time for the three versions:</p>

<p><span style="color: #ff0000;">NOTE: an updated benchmark is provided down below</span>
<span style="color: #ff0000;">NOTE2: to have a more fair performance comparison, <a href="#reloaded">keep reading</a></span>
<img class="aligncenter size-full wp-image-344" title="Benchmark results" src="http://www.skuro.tk/wp-content/uploads/2011/01/clj-bench-graph.png" alt="Average running time in ms" width="467" height="292" /></p>

<p>The results tells of a <strong>~4.5x</strong> speed gain, <del datetime="2011-01-26T09:59:07+00:00">getting close to match plain Java code performance</del>.</p>

<p>Now, even if such a benchmark won't be any news to the Clojure community, it's still <strong>absolutely awesome</strong> to see such a performance gain in the next release of this beautiful Lispy language :-)</p>

<p><strong>Update: </strong>following the advice by <strong>Jürgen Hötzel</strong> in his comment, I slightly modified my Clojure sources to change <span style="font-family: monospace;"><a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/-">clojure.core/-</a></span> with <span style="font-family: monospace;"><a href="http://clojure.github.com/clojure/clojure.core-api.html#clojure.core/unchecked-subtract">clojure.core/unchecked-subtract</a></span> and re-run the test. Here's the final results, which are way better for Clojure, especially for version 1.2:</p>

<p><img class="aligncenter size-full wp-image-350" title="clj-bench-graph-unchecked" src="http://www.skuro.tk/wp-content/uploads/2011/01/clj-bench-graph-unchecked.png" alt="" width="493" height="302" /></p>

<p><strong>Update 2:</strong> the following graph shows the impact of the direct use of the <span style="font-family: monospace;">recur</span> special form tested against plain recursive invocation of Tak, as per requested in some comments
<img class="aligncenter size-full wp-image-353" title="clj-bench-graph-norecur" src="http://www.skuro.tk/wp-content/uploads/2011/01/clj-bench-graph-norecur.png" alt="" width="476" height="267" /></p>

<p><strong>Update 3:<a name="reloaded"></a></strong> even if this all started as a quick&amp;dirty, amatorial benchmark, it attracted quite some <a href="http://news.ycombinator.com/item?id=2134950">attentions</a>, demanding more fair and precise benchmarks, especially on the Java vs Clojure comparison. As in the Java version of Tak I used Integers and not primitive types, there is an unfair burden Java had to carry along the computation. The following is the result of a re-run of the test for Java (using primitive <span style="font-family: monospace;">long</span>) and Clojure 1.3:
<img class="aligncenter size-full wp-image-356" title="clj-bench-reloaded" src="http://www.skuro.tk/wp-content/uploads/2011/01/clj-bench-reloaded.png" alt="" width="463" height="272" /></p>

  
  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'skuro';
//    var disqus_id = '/2011/01/24/performance-boost-in-clojure-1-3';
//    var disqus_url = [location.protocol, '//', location.host, location.pathname].join('');

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  

</div>

      </div>
      
    </div>
    <div id="footer">
      <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0;margin-bottom:10px" alt="Creative Commons License" /></a><br /><span rel="dct:type" property="dct:title" href="http://purl.org/dc/dcmitype/Text">SKURO! Blog</span> by <a rel="cc:attributionURL" property="cc:attributionName" href="http://skuro.tk">Carlo Sciolla</a> is licensed under a <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.<br />Based on a work at <a rel="dct:source" href="http://skuro.tk">skuro.tk</a>.
    </div>
    </div>
    <script src="/js/jquery.min.1.4.1.js" type="text/javascript">
    </script>
    <script src="/js/skuro.js" type="text/javascript">
    </script>
  </body>
</html>
