<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html>
  <head>
    <title>SKURO! -- Shading lights</title>
    <meta name="generator" content="skuro.tk/0.1 | jekyll/0.11.0" />
    <meta name="description" content="Personal Blog of Carlo Sciolla" />
    <meta name="keywords" content="clojure,enlive,moustache,java,alfresco,lambdalf,performance" />
    <link rel="stylesheet" href="/css/skuro.css" type="text/css" media="screen" />
    <link rel="stylesheet" href="/css/font.css" type="text/css" media="screen" />
  </head>
  <body>
    <div id="container">
    <div id="wrapper">
      <div id="sidebar">
        <h1 class="homelink" id="logo">SKURO!</h1>
        <div id="links">
          <span>
            <a href="/archive/">archive</a>
          </span>
          <span>
            <a href="/category/">categories</a>
          </span>
          <span>
            <a href="/about/">about</a>
          </span>
        </div>
        <img class="homelink" src="/img/avatar.jpg" id="avatar" />
        <h4 id="underlogo">shading lights</h4>
        <div id="social">
          <div id="mousing"></div>
          <a href="http://github.com/skuro">
            <img src="/img/github.png" id="github" />
          </a>
          <a href="http://twitter.com/skuro">
            <img src="/img/twitter.png" id="twitter" />
          </a>
          <a href="http://feeds.feedburner.com/Skuro">
            <img src="/img/rss.png" id="rss" />
          </a>
          <a href="http://nl.linkedin.com/in/carlosciolla">
            <img src="/img/linkedin.png" id="linkedin" />
          </a>
        </div>
        <div id="googleads">
          <script type="text/javascript">
            <!--
                google_ad_client = "ca-pub-5536661153340295";
                /* jekyll-site */
                google_ad_slot = "1546169966";
                google_ad_width = 120;
                google_ad_height = 240;
                //-->
          </script>
          <script type="text/javascript"
                  src="http://pagead2.googlesyndication.com/pagead/show_ads.js">
          </script>
        </div>
      </div>
      
      <div id="content">
        <div class="post">
  <h1 class="title">
  <a href="/2009/09/15/alfresco-and-ldap-sync-lock-my-admin-no-more">Alfresco and LDAP sync lock my Admin no more!</a>
</h1>
<h2 class="date">
  September 15, 2009
  
   -- filed under 
  
  <a href="/category/alfresco">#alfresco</a>
  
  
</h2>

  
  <img src="/img/post/baby-ninja.jpg" class="primary" />
  
  <p>On the custom <a href="http://www.alfresco.com">Alfresco Enterprise</a> project I'm working we use LDAP sync to import users from a Novell eDirectory server[<a href="#note-1">1</a>]. Now, it happened from time to time that the user Alfresco binds itself with, i.e. the LDAP admin user, got locked in eDirectory as a "Intrusion prevention" mechanism or something like that.</p>

<p>The LDAP sysadmin said we were guilty of providing wrong credentials too many times when logging in. Which is weird, since most of the time the LDAP sync went well, which meant that either that sysadmin was seldom changing back and forth the Admin credentials or something Evil&#8482; was going on under the hood. I personally feared for the latter, but let the issue wait a bit, since staging environments seemed to work just fine.</p>

<p>Then, when my dev team grew up with three more people, the issue worsened terribly, with the admin account locked almost any hour. I really started to get bothered by it, and did some investigations.</p>

<p>It turned out, it was all working "by design", in the sense that yes, our Alfresco was providing wrong credentials and yes, the admin account was properly configured. This is how it went.</p>

<p>To be 100% sure our Alfresco configuration was correct, apart from checking every configuration file from here to eternity, I wanted to sniff the network connection to the LDAP server. When networked systems fail to work together, I always feel like I <strong>need</strong> raw network data.</p>

<p>Made a <a href="http://www.google.com/search?q=socat"><strong>socat</strong></a> tunnel[<a href="#note-2">2</a>] to look at data BEFORE it entered the encrypted VPN connection, started Alfresco and waited. And, eventually, got it: I expected one bind connection request, I got more. Plus, the first three or four attempts were using almost random user accounts, while the last showed the known LDAP admin user name and the wrong password! WTF?</p>

<p>A closer look at the <a href="http://svn.alfresco.com/repos/alfresco-open-mirror/alfresco/HEAD/root/projects/repository/source/java/org/alfresco/repo/security/authentication/ldap/LDAPInitialDirContextFactoryImpl.java">Alfresco LDAP connector</a> solved the mistery. Here's an excerpt from that code:</p>

<pre><code> // Correct principal invalid password
 env = new Hashtable(initialDirContextEnvironment.size());
 env.putAll(initialDirContextEnvironment);
 env.put(Context.SECURITY_CREDENTIALS, "sdasdasdasdasd123123123");
 try
 {

     new InitialDirContext(env);

     throw new AuthenticationException(
             "The ldap server at "
                     + env.get(Context.PROVIDER_URL)
                     + " falls back to use anonymous bind for a known principal if  invalid security credentials are presented. This is not supported.");
 }
</code></pre>

<p>That's it: Alfresco performs intentionally a number of connections that are supposed to fail, in order to infer some LDAP server configurations. The code presented here above is what made eDirectory lock the admin user: when our 5~6 developer environments started up, almost simultaneously at the morning, they performed too many wrong login attempts with the correct user name in a row before the first one eventually started using both the valid username <strong>and</strong> the correct password.</p>

<p>Setting up the allowed failed logins on eDirectory for the local testing environment, finally, solved this hidden and tedious issue. Still unclear if the Alfresco approach is really a smart one, due to some limitations of the LDAP handshake protocol I'm not aware of (well, I'm not that LDAP expert, after all) or such intentionally failing logins can/should be deleted/changed. What do you think?</p>

<p>[<a name="note-1">1</a>] Here Alfresco happens to be MultiTenant, but still we are able to import users&amp;groups from the Directory. Which has been my very first successful customization task as an Alfresco dev :)</p>

<p>[<a name="note-2">2</a>] I'll eventually end up using socat for brushing my teeth, I guess</p>

  
  <div id="disqus_thread"></div>
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'skuro';
//    var disqus_id = '/2009/09/15/alfresco-and-ldap-sync-lock-my-admin-no-more';
//    var disqus_url = [location.protocol, '//', location.host, location.pathname].join('');

    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>

  

</div>

      </div>
      
    </div>
    <div id="footer">
      <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license"><img src="http://i.creativecommons.org/l/by-sa/3.0/88x31.png" style="border-width:0;margin-bottom:10px" alt="Creative Commons License" /></a><br /><span rel="dct:type" property="dct:title" href="http://purl.org/dc/dcmitype/Text">SKURO! Blog</span> by <a rel="cc:attributionURL" property="cc:attributionName" href="http://skuro.tk">Carlo Sciolla</a> is licensed under a <a href="http://creativecommons.org/licenses/by-sa/3.0/" rel="license">Creative Commons Attribution-ShareAlike 3.0 Unported License</a>.<br />Based on a work at <a rel="dct:source" href="http://skuro.tk">skuro.tk</a>.
    </div>
    </div>
    <script src="/js/jquery.min.1.4.1.js" type="text/javascript">
    </script>
    <script src="/js/skuro.js" type="text/javascript">
    </script>
    <script type="text/javascript">
      var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
      document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
    </script>
    <script type="text/javascript">
      try{ 
        var pageTracker = _gat._getTracker("UA-6754361-1");
        pageTracker._trackPageview();
      } catch(err) {} 
</script>
  </body>
</html>
